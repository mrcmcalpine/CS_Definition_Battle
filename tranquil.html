<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tranquil Typing Game üåø</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #d4fc79, #96e6a1);
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
    }
    #gameArea {
      position: relative;
      flex: 1;
      width: 100%;
      overflow: hidden;
      z-index: 2;
    }
    .clueGroup {
      position: absolute;
      top: -80px;
      background: rgba(255,255,255,0.7);
      padding: 12px 18px;
      border-radius: 14px;
      color: #2b2b2b;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      transition: opacity 0.6s ease;
      min-width: 220px;
    }
    .clueGroup .clueLine {
      font-size: 1.7rem;
      margin: 4px 0;
    }
    .clueGroup .hidden { display: none; }

    #hud {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 1.2rem;
      color: #333;
      z-index: 3;
    }
    #inputBox {
      width: 80%;
      max-width: 450px;
      margin: 10px;
      padding: 14px;
      font-size: 1.4rem;
      border-radius: 10px;
      border: none;
      outline: none;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      z-index: 3;
    }
    #pushBackBtn {
      margin-bottom: 20px;
      padding: 10px 20px;
      font-size: 1.1rem;
      border-radius: 8px;
      border: none;
      background: #fff;
      color: #2575fc;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      z-index: 3;
    }
    #pushBackBtn:disabled { opacity: 0.5; cursor: not-allowed; }

    #gameOver {
      position: absolute;
      top: 35%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.95);
      padding: 28px 40px;
      border-radius: 14px;
      text-align: center;
      display: none;
      z-index: 4;
      font-size: 1.5rem;
      max-width: 600px;
    }
    #gameOver h2 {
      margin: 0 0 18px;
      color: #333;
      font-size: 2rem;
    }
    #missedList {
      text-align: left;
      margin-top: 14px;
      font-size: 1.2rem;
      max-height: 200px;
      overflow-y: auto;
    }
    .fade-out { opacity: 0; transition: opacity 1s ease; }
    .reveal-answer {
      margin-top: 8px;
      font-size: 1.2rem;
      color: #444;
      font-style: italic;
    }

    /* üçÉ Leaves */
    .leaf {
      position: absolute;
      top: -50px;
      width: 30px;
      height: 30px;
      background: url('https://upload.wikimedia.org/wikipedia/commons/5/57/Leaf_icon_01.svg') no-repeat center/contain;
      opacity: 0.6;
      z-index: 1;
      animation: drift linear forwards;
    }
    @keyframes drift {
      from { transform: translateY(-50px) rotate(0deg); }
      to { transform: translateY(110vh) rotate(360deg); }
    }

    /* üåä Push Back Wave Overlay */
    #wave {
      position: absolute;
      bottom: -100%;
      left: 0;
      width: 100%;
      height: 120%;
      background: radial-gradient(circle at 50% 100%, rgba(173,216,230,0.7), transparent 70%);
      z-index: 5;
      pointer-events: none;
      opacity: 0;
    }
    #wave.animate {
      animation: wavePush 1.5s ease-out forwards;
    }
    @keyframes wavePush {
      0%   { bottom: -100%; opacity: 0.8; }
      50%  { bottom: 20%; opacity: 0.6; }
      100% { bottom: 120%; opacity: 0; }
    }
  </style>
</head>
<body>
  <div id="hud">Score: <span id="score">0</span> | Lives: <span id="lives">3</span> | PushBacks: <span id="pushBacks">3</span></div>
  <div id="gameArea"></div>
  <input id="inputBox" type="text" placeholder="Type answer here..." />
  <button id="pushBackBtn">Push Back üåä</button>
  <div id="gameOver">
    <h2>Game Over üå∏</h2>
    <p>Your score: <span id="finalScore">0</span></p>
    <div id="missedList"></div>
    <button onclick="startGame()">Play Again</button>
  </div>
  <div id="wave"></div>

  <!-- üåä Sound Effects -->
  <audio id="waveSound" src="https://www.soundjay.com/nature/ocean-wave-2.mp3" preload="auto"></audio>
  <!-- üé∂ Ambient background -->
  <audio id="ambient" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" preload="auto" loop></audio>

  <script>
    const WORDS_JSON = "./words.json";

    let words = [];
    let score = 0;
    let lives = 3;
    let pushBacks = 3;
    let activeWords = [];
    let spawnInterval = 6000;
    let fallSpeed = 0.5;
    let gameRunning = false;
    let correctCount = 0;
    let missed = [];

    const gameArea = document.getElementById("gameArea");
    const inputBox = document.getElementById("inputBox");
    const scoreEl = document.getElementById("score");
    const livesEl = document.getElementById("lives");
    const pushBacksEl = document.getElementById("pushBacks");
    const pushBackBtn = document.getElementById("pushBackBtn");
    const gameOverEl = document.getElementById("gameOver");
    const finalScoreEl = document.getElementById("finalScore");
    const missedListEl = document.getElementById("missedList");
    const waveEl = document.getElementById("wave");
    const waveSound = document.getElementById("waveSound");
    const ambient = document.getElementById("ambient");

    async function loadWords() {
      const res = await fetch(WORDS_JSON);
      words = await res.json();
    }

    function startGame() {
      score = 0;
      lives = 3;
      pushBacks = 3;
      correctCount = 0;
      spawnInterval = 6000;
      fallSpeed = 0.5;
      missed = [];
      activeWords.forEach(w => w.el.remove());
      activeWords = [];
      scoreEl.textContent = score;
      livesEl.textContent = lives;
      pushBacksEl.textContent = pushBacks;
      pushBackBtn.disabled = false;
      gameOverEl.style.display = "none";
      gameRunning = true;
      ambient.volume = 0.2;
      ambient.play().catch(() => {}); // browsers block autoplay until user interaction
      gameLoop();
      spawnWord();
    }

    function spawnWord() {
      if (!gameRunning || activeWords.length >= 5) {
        setTimeout(spawnWord, spawnInterval);
        return;
      }
      const word = words[Math.floor(Math.random() * words.length)];

      let x, safe;
      do {
        x = Math.random() * (window.innerWidth - 300);
        safe = activeWords.every(w => Math.abs(parseFloat(w.el.style.left) - x) > 220);
      } while (!safe);

      const el = document.createElement("div");
      el.className = "clueGroup";
      el.style.left = x + "px";

      word.clues.forEach((clue, idx) => {
        const line = document.createElement("div");
        line.className = "clueLine" + (idx > 0 ? " hidden" : "");
        line.textContent = clue;
        el.appendChild(line);
      });

      gameArea.appendChild(el);
      activeWords.push({ answer: word.answer, clues: word.clues, el, y: -80, revealed: [true, false, false] });

      setTimeout(spawnWord, spawnInterval);
    }

    function gameLoop() {
      if (!gameRunning) return;

      activeWords.forEach((w, i) => {
        w.y += fallSpeed;
        w.el.style.top = w.y + "px";

        const lines = w.el.querySelectorAll(".clueLine");
        if (w.y > window.innerHeight / 3 && !w.revealed[1] && lines[1]) {
          lines[1].classList.remove("hidden");
          w.revealed[1] = true;
        }
        if (w.y > window.innerHeight / 2 && !w.revealed[2] && lines[2]) {
          lines[2].classList.remove("hidden");
          w.revealed[2] = true;
        }

        if (w.y > window.innerHeight - 80) {
          if (!w.el.querySelector(".reveal-answer")) {
            const ans = document.createElement("div");
            ans.className = "reveal-answer";
            ans.textContent = `Answer: ${w.answer}`;
            w.el.appendChild(ans);
            missed.push({ answer: w.answer, clues: w.clues });
          }
          setTimeout(() => { if (w.el.parentNode) gameArea.removeChild(w.el); }, 1500);
          activeWords.splice(i, 1);
          lives--;
          livesEl.textContent = lives;
          if (lives <= 0) endGame();
        }
      });

      if (score >= 30) { fallSpeed = 0.8; spawnInterval = 5000; }
      if (score >= 80) { fallSpeed = 1.2; spawnInterval = 4000; }
      if (score >= 150) { fallSpeed = 1.8; spawnInterval = 3000; }

      requestAnimationFrame(gameLoop);
    }

    function normalize(text) {
      return text.toLowerCase().replace(/[^a-z0-9]/gi, '');
    }

    function checkInput() {
      const text = inputBox.value.trim();
      if (!text) return;
      for (let i = 0; i < activeWords.length; i++) {
        if (normalize(text) === normalize(activeWords[i].answer)) {
          score += 5;
          correctCount++;
          scoreEl.textContent = score;

          activeWords[i].el.classList.add("fade-out");
          setTimeout(() => { if (activeWords[i].el.parentNode) gameArea.removeChild(activeWords[i].el); }, 1000);
          activeWords.splice(i, 1);
          inputBox.value = "";

          if (correctCount % 5 === 0) {
            pushBacks++;
            pushBacksEl.textContent = pushBacks;
            pushBackBtn.disabled = false;
          }
          return;
        }
      }
    }

    function endGame() {
      gameRunning = false;
      finalScoreEl.textContent = score;
      missedListEl.innerHTML = "<strong>Missed Words:</strong><br>" +
        (missed.length ? missed.map(m => `<div>‚ùå ${m.answer} ‚Äî Clues: ${m.clues.join(", ")}</div>`).join("") : "None");
      gameOverEl.style.display = "block";
      ambient.pause();
    }

    function pushBack() {
      if (pushBacks <= 0) return;
      pushBacks--;
      pushBacksEl.textContent = pushBacks;
      if (pushBacks <= 0) pushBackBtn.disabled = true;

      waveEl.classList.add("animate");
      waveSound.currentTime = 0;
      waveSound.play();
      setTimeout(() => waveEl.classList.remove("animate"), 1500);

      activeWords.forEach(w => {
        w.y = Math.max(w.y - window.innerHeight / 2, -80);
      });
    }

    inputBox.addEventListener("input", checkInput);
    pushBackBtn.addEventListener("click", pushBack);

    function spawnLeaf() {
      const leaf = document.createElement("div");
      leaf.className = "leaf";
      leaf.style.left = Math.random() * window.innerWidth + "px";
      const duration = 10 + Math.random() * 10;
      leaf.style.animationDuration = duration + "s";
      document.body.appendChild(leaf);
      setTimeout(() => leaf.remove(), duration * 1000);
      setTimeout(spawnLeaf, 1500);
    }

    loadWords().then(startGame);
    spawnLeaf();
  </script>
</body>
</html>
